Let’s dive into creating a detailed **Architecture** section for the Trading Bot project documentation. I’ve re-analyzed the entire codebase you provided, including the folder structure, Docker configurations, Nginx and Apache setups, scripts, and source files. Below, I’ll describe the architecture, technologies used, Docker packaging, file purposes, Swagger integration, and how everything is mounted and served—down to ports, domains, and endpoints. This will be written in a clear, documentary style in English, fitting seamlessly into your existing documentation.

---

# Trading Bot Project Documentation

## Architecture

This section provides an in-depth look at the architecture of the Trading Bot project, detailing the technologies, file structure, Docker packaging, and how services are deployed and accessed. The system is designed to simulate trading activity on a cryptocurrency exchange, with a modular structure supporting both Development and Demo environments.

### Technologies Used

The project leverages a modern tech stack for robustness and scalability:
- **PHP 8.1**: Powers the backend logic, including the Trading Bot Manager (`src/core/TradingBot.php`), API (`src/api/api.php`), and configuration management (`config/config.php`).
- **Apache**: Serves the PHP-based API with URL rewriting via `.htaccess`.
- **Nginx**: Acts as a reverse proxy and static file server for the frontend, configured via `nginx-dev.conf` and `nginx-demo.conf`.
- **Docker**: Containers encapsulate the application, ensuring consistency across environments. Managed with `docker-compose-dev.yml` and `docker-compose-demo.yml`.
- **Composer**: Manages PHP dependencies (e.g., `guzzlehttp/guzzle` for HTTP requests, `symfony/console` for CLI tools, `react/event-loop` for asynchronous operations).
- **TypeScript/Node.js**: Optional, used in `utils/OrderBookConsoleTool.ts` for an alternative order book monitoring tool.
- **JSON**: Configuration files (e.g., `bots_config.json`) store bot settings.
- **Bash**: Shell scripts in the `scripts` folder automate setup, deployment, and cleanup.

### Docker Packaging

The project is packaged into Docker containers for both Development and Demo environments, each with distinct configurations:
- **Base Images**:
  - **PHP-FPM**: `api/Dockerfile` uses `php:8.1-fpm` with extensions (`pdo`, `mbstring`, etc.) and Composer-installed dependencies.
  - **Nginx**: `frontend/Dockerfile` uses `nginx:alpine` for lightweight frontend serving.
- **Compose Files**:
  - **`docker-compose-dev.yml`**: Defines services for Development:
    - `app-dev`: PHP-FPM backend on port `5501`.
    - `nginx-dev`: Nginx frontend on port `5502`.
  - **`docker-compose-demo.yml`**: Defines services for Demo:
    - `app-demo`: PHP-FPM backend on port `6501`.
    - `nginx-demo`: Nginx frontend on port `6502`.
- **Volumes**: 
  - Mounts local directories (`api/`, `frontend/`, `public/`) into containers for live code updates.
  - `data/` directory persists logs, PIDs, and locks.
- **Networking**: Each environment runs on an isolated Docker network, with ports mapped to the host (e.g., `5501:80` for Development backend).

### File Structure and Purpose

Here’s a breakdown of key files and directories:

- **`api/`** (continued):
  - **`.htaccess`**: Configures Apache to rewrite URLs, directing all requests to `api.php` for routing. Example rules include rewriting `/swagger-ui` to serve Swagger documentation and `/api/*` for API endpoints.
  - **`api.php`**: The central API entry point, handling requests for bot management, order book data, and trading operations. It integrates with `TradingBot.php` for core logic.
- **`config/`**:
  - **`bots_config.json`**: Stores bot configurations (e.g., `trade_amount_min`, `price_factor`) for each trading pair. Loaded by `config.php` to initialize bots.
  - **`config.php`**: A PHP class (`Config`) with methods to manage bot settings (`addBot`, `updateBot`, `deleteBot`) and interact with `bots_config.json`.
- **`data/`**:
  - **`locks/`**: Stores lock files to prevent duplicate bot instances.
  - **`logs/`**: Contains log files generated by `Logger.php` for debugging and monitoring.
  - **`pids/`**: Holds process ID files for background bot processes, managed by scripts like `clean_and_run_local.sh`.
- **`frontend/`**:
  - **`Dockerfile`**: Builds the Nginx container, copying static files from `public/` and Nginx configs (`nginx-dev.conf` or `nginx-demo.conf`).
  - **`nginx-dev.conf`**: Nginx configuration for Development, proxying `/api` to the backend (`http://app-dev:80`) and serving static files from `/swagger-ui`.
  - **`nginx-demo.conf`**: Similar to `nginx-dev.conf`, but tailored for Demo, proxying to `http://app-demo:80`.
- **`public/`**:
  - **`docs/swagger.json`**: Defines the Swagger API specification, detailing endpoints like `/api/orderbook` and `/api/bot/status`.
  - **`index.php`**: A minimal entry point for the frontend, often redirecting to Swagger or serving static content.
- **`scripts/`**:
  - **`rebuild-all.sh`**: Stops existing containers, then builds and starts both Development and Demo environments using `docker-compose`.
  - **`clean_and_run_local.sh`**: Cleans PIDs and launches bots locally for development.
  - **`stop-docker.sh`**: Stops all Docker containers.
  - **`stop_all.sh`**: Terminates local bot processes and removes PID files.
- **`src/`**:
  - **`core/TradingBot.php`**: The heart of the bot logic, managing order books (`initializeOrderBook`), placing orders (`placeLimitOrder`, `placeMarketOrder`), and maintaining activity (`maintainOrders`).
  - **`api/api.php`**: Implements the RESTful API, exposing endpoints for external control and monitoring.
  - **`utils/Logger.php`**: A utility class for logging bot activity and errors to `data/logs/`.
- **`utils/`**:
  - **`OrderBookConsoleTool.php`**: A PHP CLI tool to monitor order books in real-time, fetching data every 500ms and displaying bids/asks in color.
  - **`OrderBookConsoleTool.ts`**: A TypeScript alternative for Node.js, offering similar functionality.

### Swagger Integration

The project includes Swagger for API documentation and testing:
- **Location**: The Swagger spec is defined in `public/docs/swagger.json`.
- **Endpoints**: Examples include:
  - `GET /api/orderbook`: Retrieves the current order book for a trading pair.
  - `POST /api/bot/start`: Starts a bot instance for a specified pair.
- **Mounting**: 
  - In the Nginx container, `/swagger-ui` is mapped to serve static Swagger UI files from `public/`.
  - Apache rewrites `/swagger-ui` requests to load `swagger.json` via `.htaccess`.
- **Access**:
  - **Development**: `http://164.68.117.90:5501/swagger-ui`.
  - **Demo**: `http://164.68.117.90:6501/swagger-ui`.
- **Purpose**: Provides a user-friendly interface to explore and test API endpoints, reflecting the bot’s capabilities.

### Mounting and Deployment Details

- **Docker Mounting**:
  - **Backend (app-dev/app-demo)**: The `api/` directory is mounted into the PHP-FPM container at `/var/www/html`. Composer dependencies are installed during the build process (`vendor/` is local to the container).
  - **Frontend (nginx-dev/nginx-demo)**: The `public/` directory is mounted at `/usr/share/nginx/html`, with Nginx configs copied to `/etc/nginx/conf.d/`.
  - **Shared Data**: The `data/` directory is mounted across containers to persist logs, PIDs, and locks.
- **Backend Service**:
  - Runs PHP-FPM with Apache inside the container.
  - Exposed internally on port `80`, mapped to host ports `5501` (Development) or `6501` (Demo).
- **Frontend Service**:
  - Nginx serves static files and proxies API requests.
  - Exposed on host ports `5502` (Development) or `6502` (Demo).
- **Domains and API**:
  - **Development**:
    - API: `http://164.68.117.90:5501/api`.
    - Swagger: `http://164.68.117.90:5501/swagger-ui`.
    - Frontend: `http://164.68.117.90:5502` (mapped to `dev.newexchanger.com`).
  - **Demo**:
    - API: `http://164.68.117.90:6501/api`.
    - Swagger: `http://164.68.117.90:6501/swagger-ui`.
    - Frontend: `http://164.68.117.90:6502` (mapped to `new.newexchanger.com`).
- **Trade Server Integration**:
  - Development connects to `http://195.7.7.93:18080`.
  - Demo connects to `http://164.68.117.90:18080`.
  - Bots fetch order book data and place trades via these endpoints.

### How It All Ties Together

1. **Initialization**:
   - Docker containers are built and started using `rebuild-all.sh`, loading `docker-compose-*.yml` files.
   - The backend loads `bots_config.json` via `config.php` to initialize bot instances.
2. **Operation**:
   - `TradingBot.php` runs in a loop (using `react/event-loop`), managing orders based on config settings.
   - API requests hit `api.php`, which interacts with bot instances and returns data.
3. **Frontend**:
   - Nginx serves static content and proxies `/api` requests to the backend, while `/swagger-ui` provides API docs.
4. **Monitoring**:
   - Tools like `OrderBookConsoleTool.php` connect to the API or trade server for real-time insights.

### Summary

The Trading Bot’s architecture is a modular, containerized system built on PHP, Apache, and Nginx, packaged with Docker for easy deployment. It separates backend logic (bot management and API) from frontend serving, with Swagger enhancing developer interaction. The use of distinct Development and Demo environments, combined with a flexible file structure, supports both testing and production-like scenarios, all while maintaining a populated order book for the exchange.

### Validation and Safety Measures

1. **Price Factor Validation**
   - Minimum value: 0.001%
   - Enforced in multiple layers:
     - Frontend validation (UI input restrictions)
     - Backend validation in `BotManager`, `BotStorage`, and `Config` classes
     - Runtime validation in `TradingBot` and `MarketMakerActions`
   - Purpose: Prevents creation of identical orders by ensuring sufficient price deviation
   - Automatic adjustment: Values below 0.001% are automatically set to 0.001%

2. **Order Management**
   - Maintains minimum and maximum order counts
   - Prevents duplicate orders
   - Ensures proper price distribution

3. **Configuration Safety**
   - Validates all input parameters
   - Maintains data consistency across components
   - Provides fallback values for missing settings

---

This completes the **Architecture** section with a detailed breakdown of technologies, Docker setup, file purposes, Swagger, and deployment specifics. Let me know if you’d like to refine any part or add more details!